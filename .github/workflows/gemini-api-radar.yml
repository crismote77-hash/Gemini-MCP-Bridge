name: Gemini API radar

on:
  schedule:
    # Daily at 04:23 UTC
    - cron: "23 4 * * *"
  workflow_dispatch: {}

permissions:
  contents: read
  issues: write

concurrency:
  group: gemini-api-radar
  cancel-in-progress: false

jobs:
  radar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Restore radar cache
        uses: actions/cache/restore@v4
        with:
          path: .radar_cache
          key: gemini-api-radar-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            gemini-api-radar-${{ runner.os }}-

      - name: Run radar
        id: radar
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: node scripts/gemini-api-radar.mjs

      - name: Upload radar report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: radar-report
          path: .radar_cache/report.json
          retention-days: 14

      - name: Save radar cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .radar_cache
          key: gemini-api-radar-${{ runner.os }}-${{ github.run_id }}

      - name: Open issue (if changes)
        if: steps.radar.outputs.should_open_issue == 'true'
        uses: actions/github-script@v7
        env:
          ISSUE_TITLE: ${{ steps.radar.outputs.issue_title }}
          ISSUE_BODY_PATH: ${{ steps.radar.outputs.issue_body_path }}
        with:
          script: |
            const fs = require("fs");

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = process.env.ISSUE_TITLE;
            const bodyPath = process.env.ISSUE_BODY_PATH;

            if (!title || !bodyPath) {
              core.setFailed("Missing issue title/body path outputs.");
              return;
            }

            const body = fs.readFileSync(bodyPath, "utf8");

            const labelName = "gemini-api-radar";
            try {
              await github.rest.issues.getLabel({ owner, repo, name: labelName });
            } catch (e) {
              if (e.status === 404) {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: labelName,
                  color: "0e8a16",
                  description:
                    "Automated radar reports for Gemini API model/capability changes",
                });
              } else {
                throw e;
              }
            }

            const { data: existing } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              labels: labelName,
              per_page: 100,
            });

            if (existing.some((i) => i.title === title)) {
              core.info(`Issue already open with title "${title}". Skipping.`);
              return;
            }

            const { data: issue } = await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: [labelName],
            });

            core.info(`Created issue #${issue.number}: ${issue.html_url}`);

